
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NestCRM</title>
  <meta name="description" content="Lovable Generated Project" />
  <meta name="author" content="Lovable" />
  <meta property="og:image" content="/og-image.png" />
  <!-- SPA routing fix for subdomain handling -->
  <script>
    // This helps ensure proper SPA routing on subdomains
    (function() {
      // Handle 404s in production by redirecting to index.html
      if (window.location.pathname !== '/' && !window.location.pathname.includes('.')) {
        if (document.querySelector('body > div#root') && document.querySelector('body > div#root').childElementCount === 0) {
          console.log('Fixing SPA routing for path:', window.location.pathname);
          // We're on a direct URL that should be handled by the SPA router
          window.history.replaceState(null, '', window.location.pathname);
        }
      }
      
      // Detect main domain
      const hostname = window.location.hostname;
      const isMainDomain = 
        hostname === 'nestcrm.com.au' || 
        hostname === 'www.nestcrm.com.au' || 
        hostname.startsWith('www.') ||
        hostname.includes('localhost') ||
        hostname.includes('127.0.0.1') ||
        hostname.includes('vercel.app') ||
        hostname.includes('netlify.app');
      
      // Set global flag for main domain detection
      window.__MAIN_DOMAIN_DETECTED = isMainDomain;
      
      // Special handling for cross-domain authentication
      // This helps with Supabase auth cookie issues when redirecting between domains
      const hasAuthParam = window.location.search.includes('auth_redirect');
      if (hasAuthParam) {
        console.log('Detected cross-domain auth redirect, initializing auth state...');
        // Store indicator in sessionStorage to maintain state during page refreshes
        sessionStorage.setItem('auth_redirect', 'true');
        
        // Check for auth cookies and local storage to help debug cross-domain issues
        const hasCookies = document.cookie.includes('sb-');
        const hasLocalStorage = !!localStorage.getItem('supabase.auth.token');
        console.log('Auth state check - Cookies exist:', hasCookies, 'LocalStorage exists:', hasLocalStorage);
      }

      // Handle page reload 404 errors
      window.addEventListener('unhandledrejection', function(event) {
        if (event.reason && event.reason.message && event.reason.message.includes('Failed to fetch')) {
          console.warn('Network error detected, might be a 404 on reload. Will attempt recovery...');
          // Try to refresh the page if it seems like a 404 error
          if (window.location.pathname !== '/' && !window.location.pathname.includes('.')) {
            console.log('Attempting to recover from potential 404...');
            setTimeout(() => {
              window.location.href = '/';
            }, 2000);
          }
        }
      });
    })();
  </script>
</head>

<body>
  <div id="root"></div>
  <!-- IMPORTANT: DO NOT REMOVE THIS SCRIPT TAG OR THIS VERY COMMENT! -->
  <script src="https://cdn.gpteng.co/gptengineer.js" type="module"></script>
  <script type="module" src="/src/main.tsx"></script>
</body>

</html>
